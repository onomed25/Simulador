<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Ações da B3</title>
    <link rel="stylesheet" href="styles_b3.css"> <!-- Se quiser usar um arquivo CSS externo -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <header>
        <h1>Lista de Ações da B3</h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="earn.html">Earn</a>
            <a href="b3.html"class="active">B3</a>
        </nav>
    </header>

    <div id="erro" class="erro" style="display: none;"></div>

    <ul id="listaAcoes">
        <!-- Ações serão carregadas aqui -->
    </ul>

    <script>
        async function pegarValorAcao(acao) {
            const proxyUrl = 'https://api.allorigins.win/get?url='; // Proxy para contornar CORS
            const url = `https://www.fundsexplorer.com.br/funds/${acao}`; // URL do fundo/ação

            try {
                // Requisição para pegar o valor atual da ação/fundo
                const response = await fetch(proxyUrl + encodeURIComponent(url));
                const data = await response.json();
                
                const html = data.contents;
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Buscando o preço da ação/fundo no HTML da página
                const valorElemento = doc.querySelector('.headerTicker__content__price');
                const variacaoElemento = doc.querySelector('.alta');

                if (valorElemento && variacaoElemento) {
                    let valor = valorElemento.textContent.trim();
                    let variacao = variacaoElemento.textContent.trim();

                    // Remover caracteres indesejados
                    valor = valor.replace(/[^\d,.-]/g, '');
                    variacao = variacao.replace(/[^\d,.-]/g, '');
                    
                    return { valor, variacao };
                } else {
                    throw new Error('Valor ou variação não encontrados');
                }
            } catch (error) {
                console.error('Erro ao buscar valor da ação:', error);
                return { valor: 'Erro ao carregar', variacao: 'Erro ao carregar' };
            }
        }

        async function carregarAcoes() {
            const acoes = [
                { simbolo: 'mxrf11', nome: 'MXRF11 - Fundo Imobiliário' },
                {simbolo: 'gare11', nome: 'GARE11 - GUARDIAN LOGISTICA'},
                 {simbolo: 'xpsf11', nome: 'XPSF11 - Fundo De Fundos'}
  
  
            ];

            const listaAcoes = document.getElementById('listaAcoes');
            const erroDiv = document.getElementById('erro');

            // Limpa qualquer erro anterior
            erroDiv.style.display = 'none';

            // Para cada ação na lista, busca os dados e exibe
            for (const acao of acoes) {
                const { valor, variacao } = await pegarValorAcao(acao.simbolo);

                // Se o valor ou a variação forem inválidos, continua para a próxima ação
                if (valor === 'Erro ao carregar' || variacao === 'Erro ao carregar') {
                    erroDiv.style.display = 'block';
                    erroDiv.textContent = 'Erro ao carregar algumas ações.';
                    continue;
                }

                // Convertendo valores para numéricos
                const valorNumerico = parseFloat(valor.replace(',', '.'));
                const variacaoNumerica = parseFloat(variacao.replace(',', '.'));

                // Adiciona a classe "valor-positivo" ou "valor-negativo" dependendo do valor
                const valorClasse = valorNumerico > 0 ? 'valor-positivo' : 'valor-negativo';
                const variacaoClasse = variacaoNumerica >= 0 ? 'variacao-positivo' : 'variacao-negativo';

                // Formatar valor para moeda (R$)
                const valorFormatado = `R$ ${valorNumerico.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                // Agora, vamos formatar a variação como um número com até 2 casas decimais
                const variacaoFormatada = `${(variacaoNumerica).toFixed(2)}%`;

                // Criando o item de lista para cada ação
                const li = document.createElement('li');
                li.innerHTML = `<a href="Rendimento.html?fundo=${acao.simbolo}" target="_blank">${acao.nome}</a>
                                <span class="valor ${valorClasse}">${valorFormatado}</span>
                                <span class="variacao ${variacaoClasse}">${variacaoFormatada}</span>`;
                listaAcoes.appendChild(li);
            }
        }

        // Chama a função para carregar as ações e seus valores
        carregarAcoes();
    </script>

</body>
</html>
